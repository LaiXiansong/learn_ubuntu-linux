# chapter 7
## 7.1 编译Unix软件包
安装软件包含以下几个步骤：
1. 定位源码
2. 解包源码
3. 编译代码
4. 安装可执行结果
5. 给安装文件夹设置路径
### 7.1.1 编译源码
高级的语言代码需要转化为计算里可以理解的目标代码。

高级语言代码先转化为汇编语言，最后转化为目标代码。目标代码链接到包含某些内置汉书的函数库，最后产生可执行文件。

### 7.1.2 make 和 Makefile
make命令允许程序员管理大型程序和程序组。在编译时仅编译上次编译后程序已经更改的部分，提高效率。

Makefile是和源码在同一目录下的文件，提供编译的规则。它包含有关如何编译软件的信息，例如 优化级别，是否在可执行文件中包含调试信息。 它还包含有关在哪里安装已编译的二进制文件（可执行文件）、手册页、数据文件、依赖库文件、配置文件等的信息。

有些包可能会要求你自己编写Makefile。

### 7.1.3 配置
Unix有很多变体，而变体的数量越来越多，写一个兼容多变体的程序非常困难。开发者没有每个系统的权限，而且有的系统每个版本的特征一直在变化。

GNU配置和构建系统简化了程序的构建：所有的的程序都用同一简单、标准化的两步过程构建完成，不需要安装过多的特殊工具。

编译包的最简单方式是：
1. `cd`定位安装目录
2. `./configure`为系统配置包
3. `make`编译包
4. 可选`make check`允许自我测试
5. `make install`安装数据文件和文档
6. 可选`make clean`从源代码目录中删除程序二进制文件和目标文件

`--help`能够获取特定配置脚本的有趣选项列表。

其中最有可能用到的通用选项是`--prefix`和`exec-prefix`，用于指定安装目录。
* `--prefix`命名的目录保存与机器无关的文件
* `--exec-prefix`命名的目录依赖及其的文件，比如可执行文件
## 7.2 编译源码的顺序
1. 建立文件夹并下载

       mkdir download
       # download the software here
   
       cd download
       ls -l
       
2. 抽取源码
下载得到的一般是*.tar.gz文件，tar代表将几个文件和文件夹转化为了一个

首先解压：

    gunzip units-1.74.tar.gz
然后抽取文件：

    tar -xvf units-1.74.tar
接着就是`list`以及`cd`操作。

3. 配置并创建Makefile

先详细阅读README文件和INSTALL文本文档(`less`)，单元包使用GNU配置系统编译源码。

在主系统目录下没有写的权限，建立一个程序目录：

    mkdir ~/units174
设置安装路径：

    ./configure --prefix=$HOME/units174
(`$HOME`是一个环境变量，`echo $HOME`能够显示这个变量中的所有内容)
       
如果`condigure`正常运行，将会生成一个包含所有必要选项的Makedile文件。

4. 构建软件包
继续，用`make`命令构建包，一两分钟后，可执行文件就生成了，用`make check`检查所有的是否成功编译完成。

然后安装：

    make install
5. 运行软件
`cd ～/units174`到目标文件夹，可以看到目录下有以下子文件夹：

| dir name | explain |
|---------|--------|
| bin | 二进制可执行文件 |
| info | GNU信息格式的文档 |
| man | 参考文档 |
| share | 共享数据文件 |

# 7.3 跳过不必要的代码

软件开发时，将调试信息包含在结果可执行文件中是很有用的：这样，程序执行遇到问题的时候程序员可以将这个可执行文件放到一个调试软件包中，跟踪软件bug。

但是在编译源码的时候这些一般是没有必要的，毕竟完成了的代码很少出现问题，所以可以跳过这些信息，得到一个更小的可执行文件。

* 先看看**bin**文件夹下的文件大小，100k：
```
cd ~/units174/bin
ls -l
```
通过`file units`得到更多信息;

发现其中一项描述就是**not stripped**，通过以下命令跳过所有的调试和行编号信息：
```
stripp units
```
跳过之后的文件仅有36k

也可以直接在安装软件的时候就跳过调试信息：

    make install-strip
